<?php
/**
 * @file
 * Tests for the shareaholic module
 */
class ShareaholicTestCase extends DrupalWebTestCase {

  public static function getInfo(){
    return array(
      'name' => 'shareaholic module functionality',
      'description' => 'Tests hooks in the shareaholic module',
      'group' => 'Shareaholic',
    );
  }

  public function setUp() {
    parent::setUp('shareaholic');
    $this->big_user = $this->drupalCreateUser(array('administer site configuration', 'administer modules'));
    $this->user_admin_access = $this->drupalCreateUser(array('administer site configuration', 'access administration pages'));
  }

  public function testMenu() {
    $items = module_invoke('shareaholic', 'menu');
    $this->assertNotNull($items['admin/config/shareaholic'], 'The admin block should exist');
    $this->assertNotNull($items['admin/config/shareaholic/advanced'], 'The advanced settings should exist');
    $this->assertNotNull($items['admin/config/shareaholic/settings'], 'The configure settings should exist');
  }

  public function testShareaholicAdminSettings() {
    ob_start();
    module_invoke('shareaholic', 'shareaholic_admin_advanced');
    $output = ob_get_clean();
    $this->assertNotNull($output, 'There should be a theme/template for shareaholic admin page');
  }

  public function testShareaholicTheme() {
    $themes = module_invoke('shareaholic', 'theme');
    $result = (isset($themes['shareaholic_admin_advanced']) &&
                isset($themes['shareaholic_tos_modal']) &&
                isset($themes['shareaholic_failure_modal']) &&
                isset($themes['shareaholic_verify_api_key']));
    $this->assertTrue($result, 'It should have the expected themes');

  }

  public function testHtmlHeadAlter() {
    variable_set('shareaholic_has_accepted_tos', true);
    variable_set('shareaholic_settings', array('api_key' => 'test'));
    $this->drupalLogin($this->big_user);

    // Check to see if the home page has Shareaholic JS code
    $this->drupalGet('');
    $this->assertRaw('/assets/pub/shareaholic.js', 'It should have the JS script in the page');
    $this->assertRaw('Shareaholic.init(site_id, page_config)', 'It should have the JS init call in the page');

    // Check that the admin pages do not have Shareaholic JS code
    $this->drupalGet('admin/modules');
    $this->assertNoRaw('/assets/pub/shareaholic.js', 'It should not have the JS script in the page');
    $this->assertNoRaw('Shareaholic.init(site_id, page_config)', 'It should not have the JS init call in the page');
  }

  public function testInsertXUACompatible() {
    // make request to home page. Then check for XUA Compatible header
    ShareaholicUtilities::accept_terms_of_service();
    ShareaholicUtilities::update_options(array(
      'api_key' => 'test'
    ));
    $this->drupalGet('');
    $header = DrupalWebTestCase::drupalGetHeader('X-UA-Compatible');
    $this->assertNotNull($header, 'The X-UA-Compatible header should not be null');
  }

  public function testTermsOfServiceNotice() {
    variable_set('shareaholic_has_accepted_tos', false);
    $this->drupalLogin($this->big_user);
    $this->drupalGet('admin/modules');
    $this->assertRaw("Action required: You've installed Shareaholic for Drupal", 'If I am admin on admin page and did not accept ToS, notice should show');

    $this->drupalGet('admin/config/shareaholic/settings');
    $this->assertNoRaw("Action required: You've installed Shareaholic for Drupal", 'If I am admin on shareaholic settings, notice should not show');

    $this->drupalGet('');
    $this->assertNoRaw("Action required: You've installed Shareaholic for Drupal", 'If I am on index page, notice should not show');

    variable_set('shareaholic_has_accepted_tos', true);
    $this->drupalGet('admin/modules');
    $this->assertNoRaw("Action required: You've installed Shareaholic for Drupal", 'If accepted ToS, notice should not show');

    variable_set('shareaholic_has_accepted_tos', false);
    $this->drupalLogin($this->user_admin_access);
    $this->drupalGet('admin');
    $this->assertNoRaw("Action required: You've installed Shareaholic for Drupal", 'If user cannot admin modules, notice should not show');
  }



}