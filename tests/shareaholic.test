<?php
/**
 * @file
 * Tests for the shareaholic module
 */
class ShareaholicTestCase extends DrupalWebTestCase {

  public static function getInfo(){
    return array(
      'name' => 'shareaholic module functionality',
      'description' => 'Tests hooks in the shareaholic module',
      'group' => 'Shareaholic',
    );
  }

  public function setUp() {
    parent::setUp('shareaholic');
    $this->big_user = $this->drupalCreateUser(array('administer site configuration'));
  }

  public function testMenu() {
    $items = module_invoke('shareaholic', 'menu');
    $this->assertNotNull($items['admin/config/content/shareaholic/settings'], 'The configure settings should exist');
  }

  public function testShareaholicAdminSettings() {
    ob_start();
    module_invoke('shareaholic', 'shareaholic_admin_settings');
    $output = ob_get_clean();
    $this->assertNotNull($output, 'There should be a theme/template for shareaholic admin page');
  }

  public function testShareaholicTheme() {
    $themes = module_invoke('shareaholic', 'theme');
    $result = (isset($themes['shareaholic_admin_settings']) &&
                isset($themes['shareaholic_terms_of_service_modal']) &&
                isset($themes['shareaholic_failed_to_create_api_key_modal']));
    $this->assertTrue($result, 'It should have the expected themes');

  }

  public function testHtmlHeadAlter() {
    variable_set('shareaholic_has_accepted_tos', true);
    variable_set('shareaholic_settings', array('api_key' => 'test'));
    $this->drupalLogin($this->big_user);

    // Check to see if the home page has Shareaholic JS code
    $this->drupalGet('');
    $this->assertRaw('/assets/pub/shareaholic.js', 'It should have the JS script in the page');
    $this->assertRaw('Shareaholic.init(site_id)', 'It should have the JS init call in the page');

    // Check that the admin pages do not have Shareaholic JS code
    $this->drupalGet('admin/modules');
    $this->assertNoRaw('/assets/pub/shareaholic.js', 'It should not have the JS script in the page');
    $this->assertNoRaw('Shareaholic.init(site_id)', 'It should not have the JS init call in the page');
  }


  public function testInsertDisableAnalyticsMetaTag() {
    ShareaholicUtilities::update_options(array(
      'disable_analytics' => 'on',
      'api_key' => 'test'
    ));
    ShareaholicUtilities::accept_terms_of_service();

    // Check to see if the home page has Shareaholic JS code
    $this->drupalGet('');
    $this->assertRaw('<meta name="shareaholic:analytics" content="disabled" />',
                    'It should have the disable analytics metatag on the page');

    ShareaholicUtilities::update_options(array(
      'disable_analytics' => 'off'
    ));

    // check again to see if there is no disable analytics meta tag
    $this->drupalGet('');
    $this->assertNoRaw('<meta name="shareaholic:analytics" content="disabled" />',
                        'It should not have the disable analytics metatag on the page');
  }

  public function testInsertXUACompatible() {
    // make request to home page. Then check for XUA Compatible header
    ShareaholicUtilities::accept_terms_of_service();
    ShareaholicUtilities::update_options(array(
      'api_key' => 'test'
    ));
    $this->drupalGet('');
    $header = DrupalWebTestCase::drupalGetHeader('X-UA-Compatible');
    $this->assertNotNull($header, 'The X-UA-Compatible header should not be null');
  }



}